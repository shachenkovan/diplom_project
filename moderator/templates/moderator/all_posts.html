<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>–ü–æ—Å—Ç—ã</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('.static', filename='css/moderator.css') }}">
</head>
<body>
<div class="page-wrapper">
    <header>
        <h1>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ-—Å–ø—Ä–∞–≤–æ—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</h1>
        <nav>
            <a href="{{ url_for('go_main') }}">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="{{ url_for('user.main') }}">–ù–æ–≤–æ—Å—Ç–Ω–∞—è –ª–µ–Ω—Ç–∞</a>
            <a href="{{ url_for('logout') }}">–í—ã–π—Ç–∏</a>
        </nav>
    </header>

    <div class="all-content">

    <div class="container">

            <h1>–ü–æ—Å—Ç—ã</h1>

        {% for cat, msg in get_flashed_messages(True) %}
            <div class="flash {{cat}}">{{msg}}</div>
        {% endfor %}

        <form action="{{ url_for('.all_posts') }}" class="search-form" method="GET">
                <input type="text" name="search" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å">
                <button type="submit" class="btn" id="search">–ù–∞–π—Ç–∏ üîç</button>
            </form>

            <div id="posts">
    {% for post in posts %}
        <div class="post" id="post-{{ post.id }}">
                <h3>{{ post.title }}</h3>
                <p><a href="{{ url_for('.post', post_id=post.id) }}">{{ post.description[:100] }}{% if post.description|length > 100 %}...{% endif %}</a></p>
            {% if current_user.role_id != 2 %}
                <div class="links" id="buttons">
                    {% if post.published == 0 %}
                    <button class="btn_all_posts publish-btn" onclick="publishPost('{{ post.id }}')">–í—ã–ª–æ–∂–∏—Ç—å</button>
                    {% endif %}
                    <a href="{{ url_for('.edit_post', post_id=post.id) }}" class="edit-btn">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <a href="{{ url_for('.post', post_id=post.id) }}" class="edit-btn">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ—Å—Ç—É</a>
                    <button class="btn_all_posts del_post" onclick="showModal('{{ post.id }}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            {% endif %}
        </div>
    {% endfor %}
</div>

    </div>
    </div>

    <footer>
    <p>–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ | 2025</p>
    </footer>

</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<div class="modal" id="confirmModal">
  <div class="modal-content">
    <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?</p>
    <div class="modal-buttons">
      <button class="btn-confirm" id="confirmDeleteBtn">–£–¥–∞–ª–∏—Ç—å</button>
      <button class="btn-cancel" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<script>
let selectedPostId = null;

// –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function showModal(postId) {
    selectedPostId = postId;
    document.getElementById("confirmModal").style.display = "flex";
}

// –°–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
function closeModal() {
    document.getElementById("confirmModal").style.display = "none";
    selectedPostId = null;
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("confirmDeleteBtn").addEventListener("click", async function () {
        if (!selectedPostId) return;

        try {
            const response = await fetch('/moderator/all_posts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: selectedPostId, action: 'delete' }),
            });

            const data = await response.json();

            if (response.ok) {
                alert(data.message);
                const postElement = document.getElementById(`post-${selectedPostId}`);
                if (postElement) {
                    postElement.remove();
                }
            } else {
                alert(`–û—à–∏–±–∫–∞: ${data.message}`);
            }
        } catch (error) {
            alert(`–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ${error.message}`);
        } finally {
            closeModal();
        }
    });
});

    function publishPost(postId) {
    fetch('/moderator/all_posts', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ id: postId, action: 'publish' }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // –û–±–Ω–æ–≤–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ —É–¥–∞–ª–∏–º –∫–Ω–æ–ø–∫—É "–í—ã–ª–æ–∂–∏—Ç—å"
            const postElem = document.getElementById(`post-${postId}`);
            const publishBtn = postElem.querySelector('.publish-btn');
            if (publishBtn) publishBtn.remove();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.message);
        }
    })
    .catch(error => {
        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);
    });
}
</script>


</body>
</html>
